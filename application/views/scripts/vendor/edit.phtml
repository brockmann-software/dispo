<script>
var notIE_popup = null;
var lastInbLine;

function closeDialog(cert)
{
	certRow = document.getElementById(cert.No);
	if (certRow!=null) {
		document.getElementById(certRow.id+'_cert_id').value = cert.cert_id;
		document.getElementById(certRow.id+'_due').value = cert.due_date;
		document.getElementById(certRow.id+'_remark').value = cert.remark;
	}
		
	if (notIE_popup != null)  {
		notIE_popup.close();
		notIE_popup = null;
	}
}

function closeSDDialog(result)
{
	var vendor_agreements = document.getElementById('vendor_agreements');
	if (vendor_agreements.value == '0') {
		var new_option = document.createElement('option');
		new_option.text = result.version_year;
		new_option.value = result.No;
		vendor_agreements.add(new_option);
		vendor_agreements.value = result.No;
	}
	if (notIE_popup != null)  {
		notIE_popup.close();
		notIE_popup = null;
	}
}

function newCertRow(row)
{
	row.id = 'new';
	var cell0 = row.insertCell(0);
	var cell1 = row.insertCell(1);
	cell1.className = 'data';
	var cert_select = document.getElementById('int_cert').cloneNode(true);
	cert_select.name = 'new_cert';
	cert_select.id = 'new_cert';
	cell1.appendChild(cert_select);
	var cell2 = row.insertCell(2);
	cell2.className = 'data';
	var scope_select = document.getElementById('int_scope').cloneNode(true);
	scope_select.name = 'new_scope';
	scope_select.id = 'new_scope';
	cell2.appendChild(scope_select);
	var cell3 = row.insertCell(3);
	cell3.className = 'data';
	var cert_id_inp = document.createElement('input');
	cert_id_inp.type = 'text';
	cert_id_inp.name = 'new_cert_id';
	cert_id_inp.id = 'new_cert_id';
	cert_id_inp.size = 15;
	cert_id_inp.value = '';
	cell3.appendChild(cert_id_inp);
	var cell4 = row.insertCell(4);
	cell4.className = 'data';
	var due_date_inp = document.createElement('input');
	due_date_inp.type = 'text';
	due_date_inp.name = 'new_due';
	due_date_inp.id = 'new_due';
	due_date_inp.size = 15;
	due_date_inp.value = '';
	cell4.appendChild(due_date_inp);
	var cell5 = row.insertCell(5);
	cell5.className = 'data';
	var remark_inp = document.createElement('input');
	remark_inp.type = 'text';
	remark_inp.name = 'new_remark';
	remark_inp.id = 'new_remark';
	remark_inp.size = 25;
	remark_inp.value = '';
	cell5.appendChild(remark_inp);
}	

function insertCert(field)
{
	var No;
	
	function insertCertXML()
	{
		if (http.readyState == 4) {
			if (http.responseXML) {
				errorCount = getXMLTagValue(http.responseXML, 'errorCount') || 0;
				if (errorCount==0) {
					new_No = getXMLTagValue(http.responseXML, 'No') || 0;
					certificate.value = getXMLTagValue(http.responseXML, 'certificate') || 0;
					certificate.name = new_No+'_cert';
					certificate.id = new_No+'_cert';
					scope.value = getXMLTagValue(http.responseXML, 'scope') || 0;
					scope.name = new_No+'_scope';
					scope.id = new_No+'_scope';
					cert_id.value = getXMLTagValue(http.responseXML, 'cert_id') || '';
					cert_id.name = new_No+'_cert_id';
					cert_id.id = new_No+'_cert_id';
					due = getXMLTagValue(http.responseXML, 'due_date') || '<?php echo date('Y-m-d'); ?>';
					due_array = due.split('-');
					due_date.value = due_array[2]+'.'+due_array[1]+'.'+due_array[0];
					due_date.name = new_No+'_due';
					due_date.id = new_No+'_due';
					remark.value = getXMLTagValue(http.responseXML, 'remark') || '';
					remark.name = new_No+'_remark';
					remark.id = new_No+'_remark';
					if (No == 'new') {
						document.getElementById(No).id = new_No;
						certTable = document.getElementById('certificates').getElementsByTagName('tbody')[0];
						newRow = certTable.insertRow(certTable.rows.length);
						newCertRow(newRow);
						var edit_ref = document.createElement('a');
						edit_ref.onclick = function() { openCertDialog(this); }
						edit_ref.innerHTML = '<img src="/images/b_edit.png" alt="bearbeiten" title="bearbeiten" />';
						var del_ref = document.createElement('a');
						del_ref.onclick = function(){ deleteCert(this); }
						del_ref.innerHTML = '<img src="/images/b_drop.png" alt"löschen" title="löschen" />';
						row.cells[0].appendChild(edit_ref);
						row.cells[0].appendChild(del_ref);
					}
				} else {
					var errTxt = '';
					errors = http.responseXML.getElementsByTagName('error');
					for (ec = 0; ec<errors.length; ec++) {
						errTxt+=getXMLTagValue(errors[ec], 'error_field')+' ';
						errTxt+=getXMLTagValue(errors[ec], 'error_text')+'\n';
					}
					alert(errTxt);
				}
			} else {
				alert(http.responseText);
			}
		}
	}
	
	row = field.parentNode.parentNode;
	No = row.id;
	if (field.id == No+'_due') checkDate(field.id);
	var vendor = document.getElementById('old_No');
	var certificate = document.getElementById(No+'_cert');
	var scope = document.getElementById(No+'_scope');
	var cert_id = document.getElementById(No+'_cert_id');
	var due_date = document.getElementById(No+'_due');
	var remark = document.getElementById(No+'_remark');
	var params = 'No='+No+'&vendor='+vendor.value+'&certificate='+certificate.value+'&scope='+scope.value+'&cert_id='+cert_id.value+'&due_date='+due_date.value+'&remark='+remark.value;
	uri = '/vendor/updatecert/';
	upload = true;
	if (No=='new') {
		upload = confirm('Neues Zertifikat wird erfasst!');
	}
	if (upload) {
		createRequest();
		sendRequest('POST', uri, params, insertCertXML, false);
	}
}

function deleteCert(node)
{
	function deleteCertXML()
	{
		if (http.readyState==4) {
			if (http.responseXML) {
				errorCount = getXMLTagValue(http.responseXML, 'errorCount') || 0;
				if (errorCount==0) {
					certTable = document.getElementById('certificates').getElementsByTagName('tbody')[0];
					certTable.deleteRow(row.sectionRowIndex);
				} else {
					var errTxt = '';
					errors = http.responseXML.getElementsByTagName('error');
					for (ec = 0; ec<errors.length; ec++) {
						errTxt+=getXMLTagValue(errors[ec], 'error_field')+' ';
						errTxt+=getXMLTagValue(errors[ec], 'error_text')+'\n';
					}
					alert(errTxt);
				}
			} else {
				alert(http.responseText);
			}
		}
	}
	
	var row = node.parentNode.parentNode;
	var No = row.id;
	params = 'No='+No;
	if (confirm('Das Zertifikat wird geöscht')) {
		createRequest();
		sendRequest('POST', '/vendor/deletecert/', params, deleteCertXML, false);
	}
}

function openCertDialog(node)
{
	var row = node.parentNode.parentNode;
	var No = row.id;
	
	URI = '/vendor/editcert/No/'+No;
/*	if (!window.showModalDialog) {
		notIE_popup = window.open(URI, 'Zertifikate', 'dialogWidth=900px;dialogHeight=600px;diologLeft=0;dialogTop=100;resizable=yes;scroll=yes');

	} else {
		result=window.showModalDialog(URI,'', 'dialogWidth=900px;dialogHeight=600px;diologLeft=0;dialogTop=100;resizable=yes;scroll=yes');
	} */
	notIE_popup = window.open(URI, 'Zertifikate', 'dialogWidth=900px;dialogHeight=600px;diologLeft=0;dialogTop=100;resizable=yes;scroll=yes');
}

function openAgreementDialog(node)
{
	var No = node.value;
	var vendor = document.getElementById('old_No').value;
	if (No>-1) {
		URI = '/vendor/editagreemnt/No/'+No+'/vendor/'+vendor;
/*		if (!window.showModalDialog) {
			notIE_popup = window.open(URI, 'Lieferantenerklärung', 'dialogWidth=900px;dialogHeight=600px;diologLeft=0;dialogTop=100;resizable=yes;scroll=yes');

		} else {
			result=window.showModalDialog(URI,'', 'dialogWidth=900px;dialogHeight=600px;diologLeft=0;dialogTop=100;resizable=yes;scroll=yes');
		} */
		notIE_popup = window.open(URI, 'Lieferantenerklärung', 'dialogWidth=900px;dialogHeight=600px;diologLeft=0;dialogTop=100;resizable=yes;scroll=yes');
	}
}
</script>
<?php //Zend_Debug::dump($this->params); ?>
<?php $data = $this->params['data']; ?>
<?php $errors = $this->params['errors']; ?>
<div class="data_container">
<select name="int_scope" id="int_scope" onchange="insertCert(this)">
<?php foreach ($this->params['scopes'] as $scope) : ?>
<option value="<?php echo $scope['No']; ?>"><?php echo $scope['scope']; ?></option>
<?php endforeach ?>
</select>
<select name="int_cert" id="int_cert" onchange="insertCert(this)">
<?php foreach ($this->params['certificates'] as $certificate) : ?>
<option value="<?php echo $certificate['No']; ?>"><?php echo $certificate['certificate']; ?></option>
<?php endforeach ?>
</select>
</div>
<form action="/vendor/edit/" method="post">
<legend><?php echo $this->params['title']; ?></legend>
<fieldset>
<?php if (isset($this->errors['all'])) : ?><div class="error">
<?php echo $this->errors['all']; ?>
</div><?php  endif ?>
<table>
	<tr>
		<td></td><td><input type="hidden" name="old_No" id="old_No" value="<?php echo $data['No']; ?>" /></td>
	</tr>
	<tr>
		<td>Nummer</td>
		<td>
			<?php if (isset($errors['No'])) :?><div class="error"><?php endif ?>
			<input type="text" name="No" value="<?php echo $data['No']; ?>" />
			<?php if (isset($errors['No'])) :?><br /><?php echo $errors['No']; ?></div><?php endif ?>
		</td>
	</tr>
	<tr>
		<td>Name Zeile 1</td>
		<td>
			<?php if (isset($errors['name'])) :?><div class="error"><?php endif ?>
			<input type="text" name="name" maxlength="255" size="40" value="<?php echo $data['name']; ?>" />
			<?php if (isset($errors['name'])) :?><br /><?php echo $errors['name']; ?></div><?php endif ?>
		</td>
	</tr>
	<tr>
		<td>Name Zeile 2</td>
		<td><input type="text" name="name_2" maxlength="255" size="40" value="<?php echo $data['name_2']; ?>" /></td>
	</tr>
	<tr>
		<td>Straße Zeile 1</td>
		<td><input type="text" name="street" maxlength="255" size="40" value="<?php echo $data['street']; ?>" /></td>
	</tr>
	<tr>
		<td>Straße Zeile 2</td>
		<td><input type="text" name="street_2" maxlength="255" size="40" value="<?php echo $data['street_2']; ?>" /></td>
	</tr>
	<tr>
		<td>PLZ</td>
		<td><input type="text" name="PO_code" maxlength="20" size="5" value="<?php echo $data['PO_code']; ?>" /></td>
	</tr>
	<tr>
		<td>Ort</td>
		<td>
			<?php if (isset($errors['city'])) :?><div class="error"><?php endif ?>
			<input type="text" name="city" maxlength="255" size="40" value="<?php echo $data['city']; ?>" />
			<?php if (isset($errors['city'])) :?><br /><?php echo $errors['city']; ?></div><?php endif ?>
		</td>
	</tr>
	<tr>
		<td>Land</td>
		<td>
			<select name="country_code" id="country_code">
			<?php foreach ($this->params['countries'] as $country) : ?>
			<option value="<?php echo $country['Id'] ?>" <?php if ($country['Id']==$data['country_code']) echo 'selected'; ?>><?php echo $country['country']; ?></option>
			<?php endforeach ?>
			</select>
		</td>
	</tr>
	<tr>
		<td>Zertifikate</td>
		<td>
		<table id="certificates" style="display:block;">
		<thead>
			<tr>
				<th></th>
				<th class="data">Zertifikat</th>
				<th class="data">Bereich</th>
				<th class="data">Zert. No.</th>
				<th class="data">Gültig</th>
				<th class="data">Bemerkungen<th>
			</tr>
		</thead>
		<tbody>
		<?php foreach ($this->params['vendor_certificates'] as $vendor_certificate) : ?>
			<tr id="<?php echo $vendor_certificate['No']; ?>">
				<td>
					<a onclick="openCertDialog(this)"><img src="/images/b_edit.png" alt="bearbeiten" title="bearbeiten" /></a>
					<a onclick="deleteCert(this)"><img src="/images/b_drop.png" alt="löschen" title="löschen" /></a>
				</td>
				<td class="data"><select name="<?php echo $vendor_certificate['No']; ?>_cert" id="<?php echo $vendor_certificate['No']; ?>_cert" onchange="insertCert(this)">
								<?php foreach ($this->params['certificates'] as $certificate) : ?>
								<option value="<?php echo $certificate['No']; ?>"<?php if ($certificate['No']==$vendor_certificate['certificate']) echo " selected"; ?>><?php echo $certificate['certificate']; ?></option>
								<?php endforeach ?>
								</select></td>
				<td class="data"><select name="<?php echo $vendor_certificate['No']; ?>_scope" id="<?php echo $vendor_certificate['No']; ?>_scope" onchange="insertCert(this)">
								<?php foreach ($this->params['scopes'] as $scope) : ?>
								<option value="<?php echo $scope['No']; ?>"<?php if ($scope['No']==$vendor_certificate['scope']) echo " selected"; ?>><?php echo $scope['scope']; ?></option>
								<?php endforeach ?>
								</select></td>
				<td class="data"><input type="text" name="<?php echo $vendor_certificate['No']; ?>_cert_id" id="<?php echo $vendor_certificate['No']; ?>_cert_id" size="15" value="<?php echo $vendor_certificate['cert_id']; ?>" onchange="insertCert(this)" /></td>
				<td class="data"><input type="text" name="<?php echo $vendor_certificate['No']; ?>_due" id="<?php echo $vendor_certificate['No']; ?>_due" size="15" value="<?php echo date('d.m.Y', strtotime($vendor_certificate['due_date'])); ?>" onchange="insertCert(this)" /></td>
				<td class="data"><input type="text" name="<?php echo $vendor_certificate['No']; ?>_remark" id="<?php echo $vendor_certificate['No']; ?>_remark" size="25" value="<?php echo $vendor_certificate['remark']; ?>" onchange="insertCert(this)" /></td>
			</tr>
		<?php endforeach ?>
			<tr id="new">
				<td></td>
				<td class="data"><select name="new_cert" id="new_cert" onchange="insertCert(this)">
								<?php foreach ($this->params['certificates'] as $certificate) : ?>
								<option value="<?php echo $certificate['No']; ?>"><?php echo $certificate['certificate']; ?></option>
								<?php endforeach ?>
								</select></td>
				<td class="data"><select name="new_scope" id="new_scope" onchange="insertCert(this)">
								<?php foreach ($this->params['scopes'] as $scope) : ?>
								<option value="<?php echo $scope['No']; ?>"><?php echo $scope['scope']; ?></option>
								<?php endforeach ?>
								</select></td>
				<td class="data"><input type="text" name="new_cert_id" id="new_cert_id" size="15" value="" onchange="insertCert(this)" /></td>
				<td class="data"><input type="text" name="new_due" id="new_due" size="15" value="<?php echo date('d.m.Y'); ?>" onchange="insertCert(this)" /></td>
				<td class="data"><input type="text" name="new_remark" id="new_remark" size="25" value="" onchange="insertCert(this)" /></td>
			</tr>
		</tbody>
		</table>
		</td>
	</tr>
	<tr>
		<td>Lieferantenerklärungen</td><td><select name="vendor_agreements" id="vendor_agreements" onchange="openAgreementDialog(this)">
		<option value="-1">--</option>
		<?php foreach ($this->params['vendor_agreements'] as $agreement) : ?>
		<option value="<?php echo $agreement['No']; ?>"<?php if ($agreement['No']==$this->params['vendor_agreements'][0]['No']) echo " selected"; ?>><?php echo $agreement['version_year']; ?></option>
		<?php endforeach ?>
		<option value="0">Neu</option>
		</select><button type="button" onclick="openAgreementDialog(form.vendor_agreements)">öffnen</button></td>
	<tr>
		<td></td><td><input type="submit" name="submit" value="Speichern" /> <input type="submit" name="submit" value="Abbrechen" /></td>
	</tr>
</table>
</form>
